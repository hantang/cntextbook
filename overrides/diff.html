{% extends "main.html" %}

{% import "partials/nav-item.html" as item with context %}

<!-- Page content -->
{% block container %}
<div class="md-content md-content--post" data-md-component="content">

  <!-- Page content -->
  <article class="md-content__inner md-typeset">
    {% block content %}
    {% include "partials/content.html" %}
    <div id="diff-container"></div>
    {% endblock %}
  </article>
</div>
{% endblock %}


{% block extrahead %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
<script>
  (() => {
    // diff2html 配色映射
    const themeMap = {
      light: "d2h-light-color-scheme",
      dark: "d2h-dark-color-scheme",
      auto: "d2h-auto-color-scheme"
    };

    // 渲染 diff 内容，数据来自meta
    function renderDiff() {
      const diffContainer = document.getElementById("diff-container");
      if (!diffContainer) return;

      const diffString = `{{ page.meta.diff | e }}`;
      if (!diffString.trim()) return;

      try {
        const diffHtml = Diff2Html.html(diffString, {
          drawFileList: true,
          matching: "lines",
          outputFormat: "side-by-side",
        });
        diffContainer.innerHTML = diffHtml;
        document.querySelectorAll(".d2h-file-list-title").forEach(el => {
          el.textContent = el.textContent.replace(/Files changed \((\d+)\)/, "已变更文件 ($1) 个");
        });
      } catch (e) {
        console.error("Diff2Html render failed:", e);
        diffContainer.innerHTML = `<pre>${diffString}</pre>`;
      }
    }
    document$.subscribe(renderDiff);

    function updateColorTheme() {
      // 自动切换主题
      const wrappers = document.querySelectorAll(".d2h-file-list-wrapper, .d2h-wrapper");
      if (!wrappers.length) return;

      function updateDiffTheme() {
        const mdColorMedia = document.body.getAttribute("data-md-color-media") || "";
        let themeKey = "auto";
        if (mdColorMedia.includes("dark")) themeKey = "dark";
        else if (mdColorMedia.includes("light")) themeKey = "light";

        const d2hClass = themeMap[themeKey];
        wrappers.forEach(el => {
          Object.values(themeMap).forEach(cls => el.classList.remove(cls));
          el.classList.add(d2hClass);
        });
      }

      updateDiffTheme();
      const observer = new MutationObserver(updateDiffTheme);
      observer.observe(document.body, { attributes: true, attributeFilter: ["data-md-color-media"] });
    }
    document$.subscribe(updateColorTheme);
  })();
</script>

{% endblock %}